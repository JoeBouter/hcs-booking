<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Classroom Booking System V3</title>

<!-- ========== STYLES ========== -->
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h2 { margin-top: 20px; }
  .hidden { display: none; }
  button { margin: 5px; padding: 8px 15px; }
  input, select, textarea { margin: 5px; padding: 5px; }
  .admin-section { border: 1px solid #ccc; padding: 10px; margin-top: 20px; }
  .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
  .day { border: 1px solid #999; padding: 5px; min-height: 60px; }
</style>
</head>
<body>

<h1>Classroom Booking System</h1>

<!-- ================= LOGIN SCREEN ================= -->
<div id="loginScreen">
  <h2>Login</h2>
  <input type="text" id="loginUsername" placeholder="Username"><br>
  <input type="password" id="loginPassword" placeholder="Password"><br>
  <button onclick="login()">Login</button>
  <button onclick="showRegister()">Register New Site</button>
</div>

<!-- ================= REGISTER SCREEN ================= -->
<div id="registerScreen" class="hidden">
  <h2>Register New Site</h2>
  <input type="text" id="registerSite" placeholder="Site Name"><br>
  <input type="text" id="registerUsername" placeholder="Admin Username"><br>
  <input type="password" id="registerPassword" placeholder="Password"><br>
  <button onclick="register()">Register</button>
</div>

<!-- ================= MAIN APP ================= -->
<div id="appScreen" class="hidden">
  <h2>Welcome, <span id="currentUser"></span></h2>
  <button onclick="logout()">Logout</button>

  <!-- ===== ADMIN PANEL ===== -->
  <div id="adminPanel" class="hidden">
    <h3>Admin Panel</h3>
    <button onclick="exportData()">Export Data</button>
    <input type="file" id="importFile" onchange="importData(event)">
    <hr>

    <!-- Create Room -->
    <div class="admin-section">
      <h4>Create Room</h4>
      <input type="text" id="newRoomName" placeholder="Room name">
      <button onclick="createRoom()">Add Room</button>
      <ul id="roomList"></ul>
    </div>

    <!-- Bulk User Creation -->
    <div class="admin-section">
      <h4>Bulk User Creation</h4>
      <textarea id="bulkUsers" rows="4" cols="50" placeholder="Format: S,username,password, T,username,password, A,username,password"></textarea><br>
      <button onclick="bulkCreate()">Create Users</button>
      <ul id="userList"></ul>
    </div>

    <!-- Pending Bookings -->
    <div class="admin-section">
      <h4>Pending Bookings</h4>
      <ul id="pendingList"></ul>
    </div>
  </div>

  <!-- ===== TEACHER PANEL ===== -->
  <div id="teacherPanel" class="hidden">
    <h3>Book a Room</h3>
    <input type="date" id="bookingDate">
    <select id="bookingRoom"></select>
    <input type="text" id="bookingPeriod" placeholder="Period">
    <button onclick="requestBooking()">Request Booking</button>
  </div>

  <!-- ===== CALENDAR ===== -->
  <div id="calendarSection">
    <h3>Calendar</h3>
    <div class="calendar" id="calendar"></div>
  </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
/*
=====================
 LOCAL STORAGE SYSTEM
=====================
Stores all data per "site".
Each site has:
- users
- rooms
- bookings
- pending bookings

Future note:
SERVER INTEGRATION START/END areas are marked 
for adding server-side data syncing later.
*/

let data = JSON.parse(localStorage.getItem('bookingData')) || {};

let currentSite = null;
let currentUser = null;

/* =======================
 LOGIN / REGISTER FUNCTIONS
======================= */

function login() {
  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;

  for (const site in data) {
    const users = data[site].users || {};
    if (users[username] && users[username].password === password) {
      currentSite = site;
      currentUser = username;
      loadApp();
      return;
    }
  }
  alert("Invalid login.");
}

function showRegister() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('registerScreen').classList.remove('hidden');
}

function register() {
  const site = document.getElementById('registerSite').value;
  const username = document.getElementById('registerUsername').value;
  const password = document.getElementById('registerPassword').value;

  if (data[site]) {
    alert("Site already exists.");
    return;
  }

  data[site] = {
    users: { [username]: { password: password, role: "admin" } },
    rooms: [],
    bookings: [],
    pending: []
  };

  saveData();
  currentSite = site;
  currentUser = username;
  loadApp();
}

/* =======================
 APP LOAD / LOGOUT
======================= */

function loadApp() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('registerScreen').classList.add('hidden');
  document.getElementById('appScreen').classList.remove('hidden');

  const role = data[currentSite].users[currentUser].role;
  document.getElementById('currentUser').innerText = `${currentUser} (${role})`;

  showPanels();
  renderRooms();
  renderUsers();
  renderPending();
  renderCalendar();
}

function logout() {
  currentSite = null;
  currentUser = null;
  document.getElementById('appScreen').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
}

/* =======================
 PANEL DISPLAY
======================= */

function showPanels() {
  const role = data[currentSite].users[currentUser].role;
  document.getElementById('adminPanel').classList.toggle('hidden', role !== 'admin');
  document.getElementById('teacherPanel').classList.toggle('hidden', !(role === 'admin' || role === 'teacher'));
}

/* =======================
 ADMIN FUNCTIONS
======================= */

function createRoom() {
  const roomName = document.getElementById('newRoomName').value.trim();
  if (!roomName) return;
  data[currentSite].rooms.push(roomName);
  saveData();
  renderRooms();
}

function bulkCreate() {
  const text = document.getElementById('bulkUsers').value;
  const parts = text.split(',');
  for (let i = 0; i < parts.length; i += 3) {
    const role = parts[i]?.trim();
    const username = parts[i+1]?.trim();
    const password = parts[i+2]?.trim();
    if (role && username && password) {
      let r = (role === 'A') ? 'admin' : (role === 'T') ? 'teacher' : 'student';
      data[currentSite].users[username] = { password: password, role: r };
    }
  }
  saveData();
  renderUsers();
}

function approveBooking(index) {
  const b = data[currentSite].pending.splice(index, 1)[0];
  data[currentSite].bookings.push(b);
  saveData();
  renderPending();
  renderCalendar();
}

function declineBooking(index) {
  data[currentSite].pending.splice(index, 1);
  saveData();
  renderPending();
}

/* =======================
 TEACHER BOOKING
======================= */

function requestBooking() {
  const date = document.getElementById('bookingDate').value;
  const room = document.getElementById('bookingRoom').value;
  const period = document.getElementById('bookingPeriod').value;
  if (!date || !room || !period) {
    alert("Please fill out all fields.");
    return;
  }

  data[currentSite].pending.push({ date, room, period, user: currentUser });
  saveData();
  renderPending();
}

/* =======================
 DATA EXPORT / IMPORT
======================= */

function exportData() {
  const blob = new Blob([JSON.stringify(data[currentSite])], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${currentSite}-data.json`;
  a.click();
}

function importData(event) {
  const file = event.target.files[0];
  const reader = new FileReader();
  reader.onload = function() {
    data[currentSite] = JSON.parse(reader.result);
    saveData();
    loadApp();
  };
  reader.readAsText(file);
}

/* =======================
 RENDER FUNCTIONS
======================= */

function renderRooms() {
  const roomList = document.getElementById('roomList');
  const bookingRoom = document.getElementById('bookingRoom');
  roomList.innerHTML = '';
  bookingRoom.innerHTML = '';

  data[currentSite].rooms.forEach(room => {
    const li = document.createElement('li');
    li.textContent = room;
    roomList.appendChild(li);

    const option = document.createElement('option');
    option.value = room;
    option.textContent = room;
    bookingRoom.appendChild(option);
  });
}

function renderUsers() {
  const userList = document.getElementById('userList');
  userList.innerHTML = '';
  const users = data[currentSite].users;
  for (const u in users) {
    const li = document.createElement('li');
    li.textContent = `${u} (${users[u].role})`;
    userList.appendChild(li);
  }
}

function renderPending() {
  const list = document.getElementById('pendingList');
  list.innerHTML = '';
  data[currentSite].pending.forEach((b, i) => {
    const li = document.createElement('li');
    li.innerHTML = `${b.date} – ${b.room} – ${b.period} – ${b.user} 
      <button onclick="approveBooking(${i})">Approve</button> 
      <button onclick="declineBooking(${i})">Decline</button>`;
    list.appendChild(li);
  });
}

function renderCalendar() {
  const cal = document.getElementById('calendar');
  cal.innerHTML = '';
  for (let i = 1; i <= 30; i++) {
    const date = `2025-05-${String(i).padStart(2, '0')}`;
    const div = document.createElement('div');
    div.className = 'day';
    const todayBookings = data[currentSite].bookings.filter(b => b.date === date);
    div.innerHTML = `<strong>May ${i}</strong><br>` +
      (todayBookings.length ? todayBookings.map(b => `${b.room} – ${b.period} – ${b.user}`).join('<br>') : 'No bookings');
    cal.appendChild(div);
  }
}

/* =======================
 SAVE DATA (LOCAL STORAGE)
======================= */

function saveData() {
  localStorage.setItem('bookingData', JSON.stringify(data));

  /*
  ======== SERVER INTEGRATION START ========
  Future: Replace localStorage save with server-side API call here.
  Example:
  sendDataToServer(data[currentSite]);
  ======== SERVER INTEGRATION END ========
  */
}
</script>
</body>
</html>
