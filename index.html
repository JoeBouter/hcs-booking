<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Classroom Booking System</title>
<style>
  :root {
    --primary-color: navy;
    --secondary-color: crimson;
  }

  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f0f2f5;
    color: #222;
  }

  header {
    background-color: var(--primary-color);
    color: white;
    padding: 15px;
    text-align: center;
  }

  nav {
    background-color: #ddd;
    padding: 10px;
    text-align: center;
  }

  nav button {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 10px 15px;
    margin: 0 5px;
    cursor: pointer;
  }

  nav button.active {
    background-color: var(--secondary-color);
  }

  main {
    display: none;
    padding: 20px;
  }

  main.active {
    display: block;
  }

  .btn {
    padding: 10px 15px;
    background: var(--primary-color);
    color: white;
    border: none;
    cursor: pointer;
    margin: 5px 0;
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 10px;
  }

  .day {
    background: white;
    padding: 10px;
    border: 1px solid #ccc;
    min-height: 100px;
  }

  input[type="text"], input[type="password"], input[type="date"], select {
    padding: 5px;
    margin-bottom: 10px;
    width: 100%;
  }

  .admin-section {
    background: #e9ecef;
    padding: 10px;
    margin-top: 10px;
  }
</style>
</head>
<body>

<header>
  <h1>Classroom Booking System</h1>
</header>

<!-- ======= ONE ROW NAVIGATION ======= -->
<nav id="topNav">
  <span id="navGuest">
    <button onclick="showScreen('loginScreen')">Login</button>
    <button onclick="showScreen('registerScreen')">Register</button>
  </span>
  <span id="navUser" style="display:none;">
    <button onclick="logout()">Logout</button>
    <button onclick="showAppTab('adminPanel')">Admin Panel</button>
    <button onclick="showAppTab('bookingPanel')">Room Booking</button>
    <button onclick="showAppTab('calendarPanel')">Calendar</button>
  </span>
</nav>

<!-- ======= LOGIN ======= -->
<main id="loginScreen" class="active">
  <h2>Login</h2>
  <input type="text" id="loginUsername" placeholder="Username"><br>
  <input type="password" id="loginPassword" placeholder="Password"><br>
  <button class="btn" onclick="login()">Login</button>
</main>

<!-- ======= REGISTER ======= -->
<main id="registerScreen">
  <h2>Register New Site</h2>
  <input type="text" id="registerSite" placeholder="Site Name"><br>
  <input type="text" id="registerUsername" placeholder="Admin Username"><br>
  <input type="password" id="registerPassword" placeholder="Password"><br>
  <button class="btn" onclick="register()">Register</button>
</main>

<!-- ======= APP SCREEN ======= -->
<main id="appScreen">
  <h2>Welcome, <span id="currentUser"></span></h2>
  <!-- ADMIN PANEL -->
  <section id="adminPanel" class="app-tab active">
    <h3>Admin Panel</h3>
    <button class="btn" onclick="exportData()">Export Data</button>
    <input type="file" onchange="importData(event)">
    <br><br>

    <label>Primary Color:</label>
    <input type="color" id="siteColor" onchange="changeSiteColor()"><br>

    <label>Secondary Color (Calendar):</label>
    <input type="color" id="calendarColor" onchange="changeCalendarColor()"><br><br>

    <div class="admin-section">
      <h4>Create Room</h4>
      <input type="text" id="newRoomName" placeholder="Room name">
      <button class="btn" onclick="addRoom()">Add Room</button>
      <ul id="roomList"></ul>
    </div>

    <div class="admin-section">
      <h4>Bulk User Creation</h4>
      <textarea id="bulkUsers" placeholder="S,username,password, T,username,password, A,username,password" rows="3" style="width:100%;"></textarea><br>
      <button class="btn" onclick="bulkCreateUsers()">Create Users</button>
      <ul id="userList"></ul>
    </div>
  </section>

  <!-- BOOKING PANEL -->
  <section id="bookingPanel" class="app-tab" style="display:none;">
    <h3>Book a Room</h3>
    <form onsubmit="submitBooking(event)">
      <label>Date:</label>
      <input type="date" id="date" required><br>
      <label>Room:</label>
      <select id="roomSelect"></select><br>
      <label>Period:</label>
      <select id="period">
        <option>Period 1</option>
        <option>Period 2</option>
        <option>Period 3</option>
        <option>Lunch</option>
        <option>Period 4</option>
      </select><br>
      <button class="btn" type="submit">Submit Booking</button>
    </form>
  </section>

  <!-- CALENDAR PANEL -->
  <section id="calendarPanel" class="app-tab" style="display:none;">
    <h3>Booking Calendar</h3>
    <div>
      <button onclick="changeMonth(-1)">Previous Month</button>
      <button onclick="changeMonth(1)">Next Month</button>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
  </section>

</main> <!-- Close appScreen -->
<script>
/* ====================== DATA ====================== */
let siteData = JSON.parse(localStorage.getItem('siteData')) || {
    siteName: 'Default Site',
    users: [],
    rooms: [],
    bookings: [],
    color: '#000080',
    calendarColor: '#DC143C'
};
let currentUser = null;

let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();

/* ====================== SAVE ====================== */
function saveData() {
    localStorage.setItem('siteData', JSON.stringify(siteData));
}

/* ====================== SCREENS ====================== */
function showScreen(screen) {
    document.querySelectorAll('main').forEach(m => m.classList.remove('active'));
    document.getElementById(screen).classList.add('active');
}

/* ====================== REGISTER ====================== */
function register() {
    const site = document.getElementById('registerSite').value.trim();
    const user = document.getElementById('registerUsername').value.trim();
    const pass = document.getElementById('registerPassword').value.trim();
    if (!site || !user || !pass) return alert("Fill in all fields.");
    siteData = {
        siteName: site,
        users: [{username:user,password:pass,role:'admin'}],
        rooms: [],
        bookings: [],
        color: '#000080',
        calendarColor: '#DC143C'
    };
    saveData();
    alert("Site registered.");
    showScreen('loginScreen');
}

/* ====================== LOGIN ====================== */
function login() {
    const user = document.getElementById('loginUsername').value.trim();
    const pass = document.getElementById('loginPassword').value.trim();
    const found = siteData.users.find(u => u.username===user && u.password===pass);
    if (!found) return alert("Invalid credentials.");
    currentUser = found;
    document.getElementById('currentUser').textContent = `${found.username} (${found.role})`;
    showScreen('appScreen');
    document.getElementById('navGuest').style.display = 'none';
    document.getElementById('navUser').style.display = 'inline';
    loadApp();
}

/* ====================== LOGOUT ====================== */
function logout() {
    currentUser = null;
    showScreen('loginScreen');
    document.getElementById('navGuest').style.display = 'inline';
    document.getElementById('navUser').style.display = 'none';
}

/* ====================== APP SETUP ====================== */
function loadApp() {
    changeSiteColor();
    changeCalendarColor();
    populateRooms();
    populateUsers();
    renderCalendar();
    updateRoleVisibility();
    showAppTab('calendarPanel'); // Default tab
}

/* ====================== ROLES ====================== */
function updateRoleVisibility() {
    document.querySelector('button[onclick="showAppTab(\'adminPanel\')"]').style.display =
      (currentUser.role === 'admin') ? 'inline' : 'none';

    document.querySelector('button[onclick="showAppTab(\'bookingPanel\')"]').style.display =
      (currentUser.role === 'admin' || currentUser.role === 'teacher') ? 'inline' : 'none';
}

/* ====================== NAV TABS ====================== */
function showAppTab(tabId) {
    ['adminPanel', 'bookingPanel', 'calendarPanel'].forEach(id => {
        document.getElementById(id).style.display = (id === tabId) ? 'block' : 'none';
    });
}

/* ====================== COLORS ====================== */
function changeSiteColor() {
    let color = siteData.color;
    const picker = document.getElementById('siteColor');
    if (picker.value) color = picker.value;
    siteData.color = color;
    saveData();
    document.documentElement.style.setProperty('--primary-color', color);
}

function changeCalendarColor() {
    let color = siteData.calendarColor;
    const picker = document.getElementById('calendarColor');
    if (picker.value) color = picker.value;
    siteData.calendarColor = color;
    saveData();
    document.documentElement.style.setProperty('--secondary-color', color);
    renderCalendar();
}
/*******************************
    ADMIN: Rooms & Users
********************************/
function addRoom() {
    const name = document.getElementById('newRoomName').value.trim();
    if (!name || siteData.rooms.includes(name)) return;
    siteData.rooms.push(name);
    saveData();
    populateRooms();
    renderCalendar();
}

function populateRooms() {
    const roomList = document.getElementById('roomList');
    const roomSelect = document.getElementById('roomSelect');
    roomList.innerHTML = '';
    roomSelect.innerHTML = '';
    siteData.rooms.forEach(r => {
        const li = document.createElement('li');
        li.textContent = r;
        roomList.appendChild(li);
        const opt = document.createElement('option');
        opt.value = r;
        opt.textContent = r;
        roomSelect.appendChild(opt);
    });
}

function bulkCreateUsers() {
    const text = document.getElementById('bulkUsers').value.trim();
    const entries = text.split(',');
    for (let i = 0; i < entries.length; i += 3) {
        const role = entries[i]?.trim();
        const username = entries[i+1]?.trim();
        const password = entries[i+2]?.trim();
        if (role && username && password) {
            siteData.users.push({
                username,
                password,
                role: (role==='A'?'admin':role==='T'?'teacher':'student')
            });
        }
    }
    saveData();
    populateUsers();
}

function populateUsers() {
    const ul = document.getElementById('userList');
    ul.innerHTML = '';
    siteData.users.forEach(u => {
        const li = document.createElement('li');
        li.textContent = `${u.username} (${u.role})`;
        ul.appendChild(li);
    });
}

/*******************************
    BOOKING
********************************/
function submitBooking(e) {
    e.preventDefault();
    const date = document.getElementById('date').value;
    const room = document.getElementById('roomSelect').value;
    const period = document.getElementById('period').value;

    // Check for double booking:
    const clash = siteData.bookings.find(b => b.date === date && b.room === room && b.period === period);
    if (clash) {
        alert("This room is already booked for that period!");
        return;
    }

    siteData.bookings.push({
        date,
        room,
        period,
        user: currentUser.username
    });

    saveData();
    renderCalendar();
}

/*******************************
    CALENDAR RENDERING
********************************/
function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';

    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const today = new Date();

    for (let i = 1; i <= daysInMonth; i++) {
        const dateObj = new Date(currentYear, currentMonth, i);
        const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;

        const day = document.createElement('div');
        day.className = 'day';

        // Color shading:
        let baseColor = siteData.calendarColor;
        let color = baseColor;
        if (dateObj < today.setHours(0,0,0,0)) {
            color = shadeColor(baseColor, 0); // Past = darker
        } else if (dateObj = today.setHours(0,0,0,0)) {
            color = shadeColor(baseColor, 20); // Today = exact
        } else {
            color = shadeColor(baseColor, 40); // Future = lighter
        }

        day.style.backgroundColor = color;

        // Bookings:
        const bookings = siteData.bookings.filter(b => b.date === dateStr);
        day.innerHTML = `<strong>${dateObj.toDateString()}</strong><br>` +
            (bookings.length ? bookings.map(b => `${b.room} – ${b.period} – ${b.user}`).join('<br>') : 'No bookings');

        grid.appendChild(day);
    }
}

/*******************************
    MONTH NAVIGATION
********************************/
function changeMonth(offset) {
    currentMonth += offset;
    if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    renderCalendar();
}

/*******************************
    COLOR SHADING FUNCTION
********************************/
function shadeColor(color, percent) {
    const num = parseInt(color.replace("#",""),16),
          amt = Math.round(2.55 * percent),
          R = (num >> 16) + amt,
          G = (num >> 8 & 0x00FF) + amt,
          B = (num & 0x0000FF) + amt;
    return "#" + (0x1000000 +
        (R<255?R<1?0:R:255)*0x10000 +
        (G<255?G<1?0:G:255)*0x100 +
        (B<255?B<1?0:B:255))
        .toString(16).slice(1);
}

/*******************************
    IMPORT / EXPORT
********************************/
function exportData() {
    const blob = new Blob([JSON.stringify(siteData)], {type:"application/json"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'siteData.json';
    a.click();
}

function importData(e) {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = function() {
        siteData = JSON.parse(reader.result);
        saveData();
        loadApp();
    };
    reader.readAsText(file);
}
</script>
</body>
</html>
