<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HCS Classroom Booking</title>
  <style>
    body { font-family: sans-serif; background: #f0f0f0; padding: 20px; }
    .hidden { display: none; }
    button { padding: 10px 15px; background: #2d3e50; color: white; border: none; border-radius: 5px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
    .day { background: white; padding: 10px; border: 1px solid #ccc; border-radius: 5px; min-height: 80px; }
  </style>
</head>
<body>

<!-- Login Panel -->
<div id="authPanel">
  <h2>Welcome to HCS Booking</h2>
  <button id="loginBtn">Sign in with Google</button>
</div>

<!-- App Panel -->
<div id="appPanel" class="hidden">
  <h2>Classroom Booking</h2>
  <p id="userInfo"></p>
  <button id="logoutBtn">Log out</button>

  <nav>
    <a href="#home">Home</a>
    <a href="#bookings">Book a Room</a>
    <a href="#admin">Admin Panel</a>
  </nav>

  <main id="home">
    <h3>Bookings Calendar</h3>
    <div class="calendar-grid" id="calendarGrid"></div>
  </main>

  <main id="bookings" style="display:none;">
    <h3>Book a Classroom</h3>
    <form id="bookingForm">
      <label>Date:</label>
      <input type="date" id="date" required>
      <label>Room:</label>
      <select id="room"></select>
      <label>Period:</label>
      <select id="period">
        <option>Period 1</option>
        <option>Period 2</option>
        <option>Period 3</option>
        <option>Lunch</option>
        <option>Period 4</option>
      </select>
      <label>Your Name:</label>
      <input type="text" id="teacher" required>
      <button type="submit">Submit Booking</button>
    </form>
  </main>

  <main id="admin" style="display:none;">
    <h3>Pending Approvals</h3>
    <ul id="pendingList"></ul>

    <h3>Manage Rooms</h3>
    <input type="text" id="newRoomName" placeholder="e.g. E5" />
    <button onclick="addRoom()">Add Room</button>
    <ul id="roomList"></ul>
  </main>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
  import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBhl57b8ncjZkca9vxWng79AUuPq5WnO00",
    authDomain: "hcs-booking.firebaseapp.com",
    projectId: "hcs-booking",
    storageBucket: "hcs-booking.firebasestorage.app",
    messagingSenderId: "923003673274",
    appId: "1:923003673274:web:3fdbe3bd24775226ee4083",
    measurementId: "G-ZF0LMCXME5"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authPanel = document.getElementById('authPanel');
  const appPanel = document.getElementById('appPanel');
  const userInfo = document.getElementById('userInfo');

  const rooms = ['B1', 'B2', 'C1', 'Library'];
  const bookings = [];
  const pending = [];

  let isSigningIn = false; // Stop multiple logins

  // Room and Calendar Functions
  function populateRooms() {
    const roomSelect = document.getElementById('room');
    roomSelect.innerHTML = '';
    rooms.forEach(room => {
      const option = document.createElement('option');
      option.value = room;
      option.textContent = room;
      roomSelect.appendChild(option);
    });
  }

  function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';
    for (let i = 1; i <= 30; i++) {
      const date = `2025-05-${i.toString().padStart(2, '0')}`;
      const todayBookings = bookings.filter(b => b.date === date);
      const div = document.createElement('div');
      div.className = 'day';
      div.innerHTML = `<strong>May ${i}</strong><br>` +
        (todayBookings.length ? todayBookings.map(b => `${b.room} – ${b.period} – ${b.teacher}`).join('<br>') : 'No bookings');
      grid.appendChild(div);
    }
  }

  function renderRoomList() {
    const list = document.getElementById('roomList');
    list.innerHTML = '';
    rooms.forEach((room, index) => {
      const li = document.createElement('li');
      li.innerHTML = `${room} <button onclick="deleteRoom(${index})">Delete</button>`;
      list.appendChild(li);
    });
  }

  window.addRoom = function() {
    const name = document.getElementById('newRoomName').value.trim();
    if (name && !rooms.includes(name)) {
      rooms.push(name);
      populateRooms();
      renderRoomList();
      renderCalendar();
      alert(`Room "${name}" added.`);
    }
    document.getElementById('newRoomName').value = '';
  };

  window.deleteRoom = function(index) {
    const roomToDelete = rooms[index];
    if (confirm(`Delete room "${roomToDelete}" and its bookings?`)) {
      rooms.splice(index, 1);
      for (let i = bookings.length - 1; i >= 0; i--) if (bookings[i].room === roomToDelete) bookings.splice(i, 1);
      for (let i = pending.length - 1; i >= 0; i--) if (pending[i].room === roomToDelete) pending.splice(i, 1);
      populateRooms();
      renderRoomList();
      renderCalendar();
      renderPending();
    }
  };

  function renderPending() {
    const list = document.getElementById('pendingList');
    list.innerHTML = '';
    pending.forEach((b, i) => {
      const li = document.createElement('li');
      li.innerHTML = `${b.date} – ${b.room} – ${b.period} – ${b.teacher} 
        <button onclick="approve(${i})">Approve</button> 
        <button onclick="decline(${i})">Decline</button>`;
      list.appendChild(li);
    });
  }

  window.approve = function(i) {
    bookings.push(pending.splice(i, 1)[0]);
    renderPending();
    renderCalendar();
  };

  window.decline = function(i) {
    pending.splice(i, 1);
    renderPending();
  };

  document.getElementById('bookingForm').addEventListener('submit', e => {
    e.preventDefault();
    const date = document.getElementById('date').value;
    const room = document.getElementById('room').value;
    const period = document.getElementById('period').value;
    const teacher = document.getElementById('teacher').value;
    pending.push({ date, room, period, teacher });
    renderPending();
    alert('Booking submitted for approval.');
    e.target.reset();
  });

  document.querySelectorAll('nav a').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      const target = link.getAttribute('href').substring(1);
      document.querySelectorAll('main').forEach(m => m.style.display = 'none');
      document.getElementById(target).style.display = 'block';
    });
  });

  // Login and Redirect Logic
  document.addEventListener('DOMContentLoaded', () => {
    console.log("Page loaded");

    loginBtn.onclick = () => {
      if (!isSigningIn) {
        isSigningIn = true;
        console.log("Signing in...");
        signInWithRedirect(auth, provider).finally(() => {
          isSigningIn = false;
        });
      } else {
        console.log("Sign-in already in progress.");
      }
    };

    logoutBtn.onclick = () => {
      console.log("Signing out...");
      signOut(auth);
    };

    getRedirectResult(auth)
      .then((result) => {
        console.log("getRedirectResult promise resolved.");
        if (result && result.user) {
          console.log("Redirect sign-in successful:", result.user);
        } else {
          console.log("No redirect result.");
        }
        setupAuthStateListener();
      })
      .catch((error) => {
        console.error("Redirect error:", error);
        alert("Redirect failed: " + error.message);
        setupAuthStateListener();
      });

    function setupAuthStateListener() {
      console.log("setupAuthStateListener called");

      onAuthStateChanged(auth, (user) => {
        console.log("onAuthStateChanged triggered. User:", user);

        if (user) {
          const role = "admin"; // Hardcoded
          authPanel.classList.add("hidden");
          appPanel.classList.remove("hidden");
          userInfo.textContent = `Logged in as ${user.displayName} (${role})`;
          document.getElementById('admin').style.display = role === 'admin' ? 'block' : 'none';
          document.getElementById('bookings').style.display = (role === 'admin' || role === 'teacher') ? 'block' : 'none';
          document.getElementById('home').style.display = 'block';
        } else {
          authPanel.classList.remove("hidden");
          appPanel.classList.add("hidden");
          userInfo.textContent = "";
        }
      });
    }

    populateRooms();
    renderRoomList();
    renderCalendar();
  });
</script>
</body>
</html>
